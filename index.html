<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nuestra Historia â™¾ï¸ğŸ’–</title>
  <meta name="description" content="Diario romÃ¡ntico con portada animada, contador y calendario editable con mensajes por fecha." />
  <style>
    :root{
      --bg0:#0b0613;
      --bg1:#120720;
      --card: rgba(255,255,255,.08);
      --card2: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.16);
      --txt: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.72);
      --soft: rgba(255,255,255,.55);
      --accent:#ff4da6;
      --accent2:#ffb3d9;
      --rose:#ff2f7b;
      --good:#37d67a;
      --warn:#ffd166;
      --shadow: 0 18px 70px rgba(0,0,0,.55);
      --r: 22px;
      --r2: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--txt); font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 20% 0%, rgba(255,77,166,.18), transparent 55%),
        radial-gradient(900px 600px at 85% 10%, rgba(255,179,217,.14), transparent 50%),
        radial-gradient(700px 500px at 40% 90%, rgba(255,209,102,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh; overflow-x:hidden;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    .love{
      font-weight:950;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
      -webkit-background-clip:text;background-clip:text;color:transparent;
    }
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      color: var(--txt);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.2px;
      transition: transform .06s ease, background .2s ease, border .2s ease;
      display:inline-flex; gap:8px; align-items:center; justify-content:center;
    }
    .btn:hover{background: rgba(255,255,255,.12)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      border-color: rgba(255,47,123,.55);
      background: linear-gradient(180deg, rgba(255,47,123,.24), rgba(255,47,123,.10));
    }
    .btn.danger{
      border-color: rgba(255,93,93,.55);
      background: linear-gradient(180deg, rgba(255,93,93,.18), rgba(255,93,93,.08));
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:rgba(255,255,255,.80);
      user-select:none;
    }
    .pill b{color:#fff}

    /* Cover */
    .cover{
      position:fixed; inset:0; z-index:9999;
      display:grid; place-items:center; padding:16px;
      background:
        radial-gradient(900px 520px at 20% 20%, rgba(255,77,166,.25), transparent 55%),
        radial-gradient(750px 480px at 80% 30%, rgba(255,179,217,.20), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(255,209,102,.10), transparent 55%),
        linear-gradient(180deg, rgba(7,0,24,.96), rgba(18,7,32,.96));
      backdrop-filter: blur(10px);
      transition: opacity .35s ease, transform .35s ease;
    }
    .cover.hide{opacity:0;transform:translateY(-8px);pointer-events:none}
    .coverCard{
      width:min(980px,100%);
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      border-radius: 28px;
      box-shadow: 0 30px 120px rgba(0,0,0,.62);
      overflow:hidden; position:relative;
    }
    .coverGlow{
      position:absolute; inset:-40%;
      background: conic-gradient(from 180deg,
        rgba(255,77,166,0),
        rgba(255,77,166,.34),
        rgba(255,179,217,.22),
        rgba(255,209,102,.12),
        rgba(255,77,166,.30),
        rgba(255,77,166,0));
      filter: blur(34px);
      animation: spin 10s linear infinite;
      opacity:.95;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .petals{position:absolute; inset:0; pointer-events:none; overflow:hidden}
    .petal{
      position:absolute; top:-60px;
      width:14px; height:18px;
      border-radius: 60% 40% 60% 40%;
      background: radial-gradient(circle at 30% 30%, rgba(255,179,217,.95), rgba(255,47,123,.78));
      opacity:.75;
      transform: rotate(15deg);
      animation: fall linear infinite;
    }
    @keyframes fall{to{ transform: translateY(calc(100vh + 90px)) rotate(260deg); }}
    .coverInner{position:relative; padding:18px}
    .seal{display:flex; gap:12px; align-items:center}
    .sealIcon{
      width:52px;height:52px;border-radius:18px;display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, var(--accent2), var(--rose));
      box-shadow: 0 18px 55px rgba(0,0,0,.38);
      font-size:22px; user-select:none;
      animation: floaty 3.2s ease-in-out infinite;
    }
    @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .coverTitle{margin:0;font-size:22px;letter-spacing:.2px;line-height:1.1}
    .coverSub{margin:6px 0 0;color:rgba(255,255,255,.78);font-size:13px;line-height:1.4}
    .coverGrid{margin-top:14px; display:grid; grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width: 860px){ .coverGrid{grid-template-columns:1fr} }
    .miniCard{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.20);
      border-radius:18px;
      padding:12px;
    }
    .miniCard .k{color:rgba(255,255,255,.70); font-size:12px}
    .miniCard .v{margin-top:6px; font-weight:950; font-size:15px}
    .coverActions{
      margin-top:14px;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between;
      padding-top:14px;
      border-top:1px solid rgba(255,255,255,.14);
    }
    .coverMsg{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:10px;
    }
    .coverMsg .t{font-weight:950;font-size:12.5px;color:rgba(255,255,255,.92)}
    .coverMsg .s{margin-top:6px;font-size:12px;line-height:1.35;color:rgba(255,255,255,.72);white-space:pre-wrap}
    .coverMsg .meta{margin-top:8px;font-family:var(--mono);font-size:11px;color:rgba(255,255,255,.58)}

    /* Mini calendar */
    .calTop{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .calTitle{font-weight:950; letter-spacing:.2px}
    .calNav{display:flex; gap:8px; flex-wrap:wrap}
    .calGrid{margin-top:10px; display:grid; grid-template-columns: repeat(7, 1fr); gap:8px}
    .calDow{font-size:11px; color:rgba(255,255,255,.65); text-align:center; padding:4px 0}
    .calCell{
      position:relative;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 14px;
      min-height:54px;
      padding:8px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border .2s ease;
      overflow:hidden;
    }
    .calCell:hover{background: rgba(255,255,255,.10)}
    .calCell:active{transform: translateY(1px)}
    .calCell.muted{opacity:.38; cursor:default}
    .calNum{font-weight:950; font-size:12px}
    .calDots{position:absolute; left:8px; bottom:8px; display:flex; gap:6px; flex-wrap:wrap}
    .dot{width:7px; height:7px; border-radius:99px; background: rgba(255,255,255,.35)}
    .dot.ev{background: rgba(255,77,166,.95)}
    .dot.ann{background: rgba(255,209,102,.95)}
    .dot.mon{background: rgba(55,214,122,.90)}
    .calCell.today{border-color: rgba(255,77,166,.55)}
    .calCell.sel{outline: 2px solid rgba(255,179,217,.65); outline-offset:2px}
    .calHint{margin-top:10px; color:rgba(255,255,255,.72); font-size:12px; line-height:1.35}

    /* App */
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25));
      border-bottom:1px solid var(--line);
    }
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .brand{display:flex; align-items:center; gap:10px}
    .logo{
      width:44px;height:44px;border-radius:16px; display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, var(--accent2), var(--accent));
      box-shadow: var(--shadow);
      user-select:none; cursor:pointer;
    }
    .subline{color:var(--muted); font-size:12.5px; line-height:1.35}
    main{max-width:1100px;margin:0 auto;padding:16px 16px 26px}
    .grid{display:grid; gap:14px; grid-template-columns: 1.2fr .8fr}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hd{padding:14px 14px 10px;border-bottom:1px solid var(--line); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));}
    .hd .title{font-size:14.5px;font-weight:950;letter-spacing:.2px}
    .hd .desc{margin-top:4px;color:var(--muted);font-size:12.5px;line-height:1.35}
    .bd{padding:14px}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    input[type="text"], input[type="date"], input[type="time"], textarea, select{
      width:100%;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      border-radius: 12px;
      padding:10px 11px;
      outline:none;
    }
    textarea{min-height:120px;resize:vertical;line-height:1.45}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 560px){ .row{grid-template-columns:1fr} }
    .item{
      border:1px solid var(--line);
      background: var(--card2);
      border-radius: var(--r2);
      padding:12px;
      margin-top:10px;
    }
    .item .tag{font-family:var(--mono); font-size:12px; color:var(--muted)}
    .item h3{margin:6px 0 6px; font-size:14.5px}
    .item p{margin:0; color:rgba(255,255,255,.84); white-space:pre-wrap; line-height:1.45; font-size:13.5px}
    .btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

    /* Modals */
    .modalBack{
      position:fixed; inset:0; z-index:9998;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      padding:18px;
    }
    .modalBack.show{display:grid; place-items:center}
    .modal{
      width:min(820px, 100%);
      border:1px solid rgba(255,255,255,.18);
      background: rgba(15,8,26,.92);
      border-radius: 22px;
      box-shadow: 0 30px 90px rgba(0,0,0,.6);
      overflow:hidden;
    }
    .modalHd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .modalHd .t{font-weight:950; letter-spacing:.2px}
    .modalHd .s{margin-top:4px; font-size:12px; color:rgba(255,255,255,.74); line-height:1.35}
    .modalBd{padding:14px}
    .closeX{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color:#fff;
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:950;
    }

    /* Mobile dock */
    .dock{
      position:fixed; left:12px; right:12px; bottom:12px;
      z-index:60;
      display:none;
      gap:10px;
      padding:10px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 60px rgba(0,0,0,.45);
    }
    .dock .btn{flex:1}
    @media (max-width: 780px){
      .dock{display:flex}
      .hideOnMobile{display:none}
      body{padding-bottom:110px}
    }

    @media print{
      header,.dock,.cover,.modalBack{display:none!important}
      body{background:#fff;color:#000}
    }
  </style>
</head>
<body>

<!-- COVER -->
<section class="cover" id="cover">
  <div class="coverCard">
    <div class="coverGlow"></div>
    <div class="petals" id="petals"></div>

    <div class="coverInner">
      <div class="seal">
        <div class="sealIcon">ğŸŒ¹</div>
        <div>
          <h2 class="coverTitle">Nuestra Historia <span class="love">para la eternidad</span> â™¾ï¸</h2>
          <div class="coverSub">AquÃ­ mandan las fechas y las palabras. Lo demÃ¡sâ€¦ a la basura del universo. ğŸ˜Œ</div>
        </div>
      </div>

      <div class="coverGrid">
        <div class="miniCard">
          <div class="k">ğŸ•¯ï¸ Contador</div>
          <div class="v" id="coverTogether">â€”</div>
          <div class="coverSub" style="margin-top:8px">Ajustable. Porque el amor sÃ­, pero la fecha tambiÃ©n.</div>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <span class="pill">ğŸ“Œ <span id="togetherLabelInlineCover">Juntos</span>: <b id="togetherTextCover">â€”</b></span>
            <span class="pill">ğŸ“… PrÃ³ximo: <b id="nextMilestone">â€”</b></span>
          </div>
        </div>

        <div class="miniCard">
          <div class="calTop">
            <div>
              <div class="calTitle">ğŸ“… Calendario (con mensajes)</div>
              <div class="coverSub" style="margin-top:4px">Toca un dÃ­a para ver/agregar un mensajito.</div>
            </div>
            <div class="calNav">
              <button class="btn" id="calPrev">â¬…ï¸</button>
              <button class="btn" id="calToday">Hoy</button>
              <button class="btn" id="calNext">â¡ï¸</button>
            </div>
          </div>

          <div class="calGrid" id="calDow"></div>
          <div class="calGrid" id="calGrid"></div>

          <div class="calHint" id="calHint">
            Tip: Los puntitos dicen la verdad: ğŸ’— evento, ğŸ¥‚ aniversario mensual, ğŸŒŸ mes cumplido.
          </div>

          <div style="margin-top:12px">
            <div class="k">ğŸ“ Mensajitos del dÃ­a seleccionado</div>
            <div id="dayNotes"></div>
          </div>
        </div>
      </div>

      <div class="coverGrid" style="margin-top:12px">
        <div class="miniCard">
          <div class="k">ğŸ’Œ Ãšltimas pÃ¡ginas del diario</div>
          <div class="coverSub" style="margin-top:8px">Lo Ãºltimo que escribiste (para que la portada â€œhableâ€).</div>
          <div id="coverEntries" style="margin-top:10px; display:flex; flex-direction:column; gap:10px;"></div>
        </div>

        <div class="miniCard">
          <div class="k">âš¡ Atajo: crear mensajito</div>
          <div class="coverSub" style="margin-top:8px">Corto y al grano. Lo puedes poner en la fecha exacta.</div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>Fecha</label>
              <input type="date" id="quickDate" />
            </div>
            <div>
              <label>Tipo</label>
              <select id="quickType">
                <option value="event">ğŸ’— Fecha importante</option>
                <option value="note">ğŸ“ Nota</option>
                <option value="gift">ğŸ Idea / detalle</option>
              </select>
            </div>
          </div>

          <label>Mensajito corto</label>
          <input type="text" id="quickTitle" placeholder="Ej: Cena y carta, sin pretextos ğŸ˜Œ" />
          <label>Detalle (opcional)</label>
          <textarea id="quickBody" style="min-height:90px" placeholder="Ej: 7pm, flores, playlistâ€¦"></textarea>

          <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn primary" id="btnQuickAdd">ğŸ’¾ Guardar en esa fecha</button>
            <button class="btn" id="btnOpenSettings">âš™ï¸ Ajustes</button>
            <button class="btn" id="btnOpenSecret">ğŸ’Œ Secretos</button>
          </div>
        </div>
      </div>

      <div class="coverActions">
        <button class="btn primary" id="btnEnter">ğŸ’– Entrar</button>
        <button class="btn" id="btnGoWrite">ğŸ“ Escribir ahora</button>
        <button class="btn danger" id="btnExport">â¬‡ï¸ Exportar</button>
        <button class="btn" id="btnImport">â¬†ï¸ Importar</button>
        <input id="fileImport" type="file" accept="application/json" style="display:none" />
      </div>
    </div>
  </div>
</section>

<header>
  <div class="wrap topbar">
    <div class="brand">
      <div class="logo" id="roseHeader" title="MantÃ©n presionado para secretos ğŸ’Œ">ğŸ’–</div>
      <div>
        <div style="font-weight:950;letter-spacing:.2px">Nuestra Historia <span class="love">para la eternidad</span> â™¾ï¸</div>
        <div class="subline">
          Diario + calendario. Guardado en tu navegador.
          <span class="pill">ğŸ•¯ï¸ <span id="togetherLabelInline">Juntos</span>: <b id="togetherText">â€”</b></span>
        </div>
      </div>
    </div>

    <div class="hideOnMobile" style="display:flex; gap:8px; flex-wrap:wrap; align-items:center">
      <button class="btn" id="btnOpenCalendar">ğŸ“… Calendario</button>
      <button class="btn" id="btnSecretQuick">ğŸ’Œ Secretos</button>
      <button class="btn" id="btnSettingsQuick">âš™ï¸ Ajustes</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="hd">
        <div class="title">ğŸ“– Diario</div>
        <div class="desc">Escribe largo si quieres. Pero escribe real.</div>
      </div>
      <div class="bd">
        <label>TÃ­tulo</label>
        <input id="entryTitle" placeholder="Ej: El dÃ­a que me elegiste ğŸ’" />

        <label>Texto</label>
        <textarea id="entryText" placeholder="Escribe aquÃ­â€¦"></textarea>

        <div class="btns">
          <button class="btn primary" id="btnSaveEntry">ğŸ’¾ Guardar pÃ¡gina</button>
          <button class="btn" id="btnClearEntry">ğŸ§½ Limpiar</button>
          <span class="pill" id="autosaveState">Autoguardado: listo âœ…</span>
        </div>

        <div id="entriesList"></div>
      </div>
    </section>

    <aside class="card">
      <div class="hd">
        <div class="title">ğŸ“… Fechas importantes</div>
        <div class="desc">AquÃ­ editas tus fechas (y lo verÃ¡s en la portada).</div>
      </div>
      <div class="bd">
        <label>Ver notas por fecha</label>
        <input type="date" id="sideDate" />
        <div id="sideNotes"></div>

        <div class="item">
          <div class="tag">ğŸ“Œ Regla simple</div>
          <p>Una fecha sin mensaje es como promesa sin acciÃ³n. SÃ­ se puede, pero no se presume.</p>
        </div>
      </div>
    </aside>
  </div>
</main>

<!-- Dock mÃ³vil -->
<div class="dock">
  <button class="btn primary" id="dockWrite">ğŸ“</button>
  <button class="btn" id="dockCal">ğŸ“…</button>
  <button class="btn" id="dockSettings">âš™ï¸</button>
  <button class="btn" id="dockSecret">ğŸ’Œ</button>
</div>

<!-- Modal SETTINGS -->
<div class="modalBack" id="settingsBack" aria-hidden="true">
  <div class="modal">
    <div class="modalHd">
      <div>
        <div class="t">âš™ï¸ Ajustes del contador</div>
        <div class="s">Pon la fecha/hora real y el texto que quieres que diga.</div>
      </div>
      <button class="closeX" id="settingsClose">âœ–</button>
    </div>
    <div class="modalBd">
      <div class="row">
        <div>
          <label>Inicio (fecha)</label>
          <input type="date" id="togetherDate" />
        </div>
        <div>
          <label>Inicio (hora)</label>
          <input type="time" id="togetherTime" />
        </div>
      </div>

      <label>Etiqueta (opcional)</label>
      <input type="text" id="togetherLabel" placeholder="Ej: Desde que dijimos â€˜sÃ­â€™ ğŸ’" />

      <div class="btns">
        <button class="btn primary" id="btnSaveSettings">ğŸ’¾ Guardar</button>
        <button class="btn" id="btnCloseSettings">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal SECRETOS -->
<div class="modalBack" id="secretBack" aria-hidden="true">
  <div class="modal">
    <div class="modalHd">
      <div>
        <div class="t">ğŸ’Œ Mensajes secretos</div>
        <div class="s">Con clave. Para que solo ustedes sepan. ğŸ˜Œ</div>
      </div>
      <button class="closeX" id="secretClose">âœ–</button>
    </div>
    <div class="modalBd">
      <div class="row">
        <div>
          <label>Clave</label>
          <input type="text" id="secretKey" placeholder="Frase clave" />
        </div>
        <div style="display:flex;align-items:end">
          <button class="btn primary" id="btnUnlock" style="width:100%">ğŸ”“ Abrir</button>
        </div>
      </div>

      <div id="secretZone" style="display:none">
        <label>Tu secreto</label>
        <textarea id="secretText" placeholder="AquÃ­ va lo que NO es para ojos ajenosâ€¦"></textarea>

        <div class="btns">
          <button class="btn primary" id="btnSaveSecret">ğŸ’¾ Guardar secreto</button>
          <button class="btn" id="btnLock">ğŸ”’ Cerrar</button>
        </div>

        <div class="calHint">Privacidad casual. Si quieres cifrado fuerte, se puede.</div>
      </div>
    </div>
  </div>
</div>

<!-- Modal CALENDAR (quick on app) -->
<div class="modalBack" id="calendarBack" aria-hidden="true">
  <div class="modal">
    <div class="modalHd">
      <div>
        <div class="t">ğŸ“… Calendario y mensajitos</div>
        <div class="s">Lo que guardes aquÃ­ se verÃ¡ en la portada tambiÃ©n.</div>
      </div>
      <button class="closeX" id="calendarClose">âœ–</button>
    </div>
    <div class="modalBd">
      <label>Fecha</label>
      <input type="date" id="calDatePick" />
      <div class="btns">
        <button class="btn primary" id="calPickGo">Ver/editar</button>
        <button class="btn" id="calPickClose">Cerrar</button>
      </div>
      <div class="item" id="calPickNotes"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const KEY = "HISTORIA_CAL_V2";

  const el = (id) => document.getElementById(id);
  const nowISO = () => new Date().toISOString();

  const state = {
    meta: { createdAt: nowISO(), updatedAt: nowISO() },
    together: { startDate: "2025-08-06", startTime: "20:00", label: "Juntos" },
    entries: [],
    // notes: { "YYYY-MM-DD": [ {id,type,title,body,createdAt}, ... ] }
    notes: {},
    secrets: { keyHash: "", payload: "" },
    ui: { calYear: new Date().getFullYear(), calMonth: new Date().getMonth(), selectedDay: "" }
  };

  const DOW = ["D","L","M","M","J","V","S"];

  function save(){
    state.meta.updatedAt = nowISO();
    localStorage.setItem(KEY, JSON.stringify(state));
    pulse();
    renderAll();
  }

  function load(){
    const raw = localStorage.getItem(KEY);
    if(!raw) return;
    try{
      const s = JSON.parse(raw);
      if(s && typeof s === "object"){
        Object.assign(state, s);
        state.together = { ...state.together, ...(s.together || {}) };
        state.entries  = Array.isArray(s.entries) ? s.entries : [];
        state.notes    = (s.notes && typeof s.notes==="object") ? s.notes : {};
        state.secrets  = { ...state.secrets, ...(s.secrets || {}) };
        state.ui       = { ...state.ui, ...(s.ui || {}) };
      }
    }catch(_){}
  }

  function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
  function sanitize(s){ return (s||"").toString().trim(); }
  function esc(str){
    return (str||"").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  function pulse(){
    const badge = el("autosaveState");
    badge.textContent = "Autoguardado: listo âœ…";
    badge.style.borderColor = "rgba(55,214,122,.55)";
    setTimeout(()=> badge.style.borderColor = "rgba(255,255,255,.18)", 450);
  }

  // petals
  function seedPetals(){
    const host = el("petals");
    if(!host) return;
    host.innerHTML = "";
    const n = 18;
    for(let i=0;i<n;i++){
      const p = document.createElement("div");
      p.className = "petal";
      const left = Math.random()*100;
      const dur = 7 + Math.random()*8;
      const delay = Math.random()*6;
      const size = 10 + Math.random()*10;
      p.style.left = left + "vw";
      p.style.animationDuration = dur + "s";
      p.style.animationDelay = (-delay) + "s";
      p.style.width = size + "px";
      p.style.height = (size*1.25) + "px";
      p.style.opacity = (0.45 + Math.random()*0.4).toFixed(2);
      host.appendChild(p);
    }
  }

  // Together counter
  function parseStart(){
    const d = state.together.startDate || "";
    const t = state.together.startTime || "00:00";
    if(!d) return null;
    const [Y,M,D] = d.split("-").map(Number);
    const [h,m] = (t||"00:00").split(":").map(Number);
    return new Date(Y,(M||1)-1,D||1,h||0,m||0,0,0);
  }
  function diffTogether(){
    const start = parseStart();
    if(!start) return null;
    const now = new Date();
    let ms = now - start;
    if(ms < 0) ms = 0;
    const totalMin = Math.floor(ms / 60000);
    const days = Math.floor(totalMin / (60*24));
    const hours = Math.floor((totalMin - days*60*24)/60);
    const minutes = totalMin % 60;
    return {days,hours,minutes};
  }
  function nextMonthlyAnniversary(){
    const start = parseStart();
    if(!start) return null;
    const now = new Date();
    const day = start.getDate();
    let y = now.getFullYear();
    let m = now.getMonth();
    // if today's date has passed the day, go next month
    const candidate = new Date(y,m,day, start.getHours(), start.getMinutes(), 0, 0);
    if(candidate < now){
      m += 1;
    }
    const next = new Date(y,m,day, start.getHours(), start.getMinutes(), 0, 0);
    // Handle month overflow automatically by Date
    return next;
  }
  function renderTogether(){
    const d = diffTogether();
    const label = sanitize(state.together.label) || "Juntos";
    el("togetherLabelInline").textContent = label;
    el("togetherLabelInlineCover").textContent = label;

    if(!d){
      el("togetherText").textContent = "configura fecha";
      el("coverTogether").textContent = "Configura la fecha ğŸ•¯ï¸";
      el("togetherTextCover").textContent = "â€”";
      el("nextMilestone").textContent = "â€”";
      return;
    }
    const text = `${d.days} dÃ­as + ${d.hours}h ${d.minutes}m`;
    el("togetherText").textContent = text;
    el("coverTogether").textContent = text;
    el("togetherTextCover").textContent = text;

    const next = nextMonthlyAnniversary();
    if(next){
      const daysLeft = Math.max(0, Math.ceil((next - new Date()) / 86400000));
      el("nextMilestone").textContent = `${next.toLocaleDateString()} (faltan ${daysLeft} dÃ­a(s))`;
    } else {
      el("nextMilestone").textContent = "â€”";
    }
  }

  // Notes by date
  function ensureDateKey(dateStr){
    if(!state.notes[dateStr]) state.notes[dateStr] = [];
  }
  function addNote(dateStr, note){
    if(!dateStr){
      alert("Pon una fecha. El amor serÃ¡ libre, pero el calendario necesita dÃ­a. ğŸ˜Œ");
      return;
    }
    ensureDateKey(dateStr);
    state.notes[dateStr].push({
      id: uid(),
      type: note.type || "note",
      title: sanitize(note.title) || "Mensajito ğŸ’–",
      body: sanitize(note.body),
      createdAt: nowISO()
    });
    save();
  }
  function deleteNote(dateStr, id){
    if(!state.notes[dateStr]) return;
    state.notes[dateStr] = state.notes[dateStr].filter(n => n.id !== id);
    if(state.notes[dateStr].length === 0) delete state.notes[dateStr];
    save();
  }
  function editNote(dateStr, id, patch){
    const arr = state.notes[dateStr];
    if(!arr) return;
    const i = arr.findIndex(n => n.id === id);
    if(i < 0) return;
    arr[i] = { ...arr[i], ...patch };
    save();
  }
  function notesFor(dateStr){
    return state.notes[dateStr] || [];
  }

  // Calendar helpers
  function ymd(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const dd = String(d.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }
  function monthName(y,m){
    const dt = new Date(y,m,1);
    return dt.toLocaleString(undefined, { month:"long", year:"numeric" });
  }
  function isSameDay(a,b){
    return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate();
  }

  function getMonthlyAnniversaryDatesForMonth(y,m){
    const start = parseStart();
    if(!start) return [];
    const day = start.getDate();
    const dt = new Date(y,m,day,0,0,0,0);
    // dt may roll to next month if day > daysInMonth; in that case, ignore.
    if(dt.getMonth() !== m) return [];
    return [ymd(dt)];
  }

  function getMonthCompletedDatesForMonth(y,m){
    // "mes cumplido" = same day-of-month as start, but label "X meses"
    // We'll mark same day as anniversary too, but with different dot (mon).
    return getMonthlyAnniversaryDatesForMonth(y,m);
  }

  function renderCalendar(){
    const y = state.ui.calYear;
    const m = state.ui.calMonth;
    const grid = el("calGrid");
    const dow = el("calDow");
    dow.innerHTML = DOW.map(d=>`<div class="calDow">${d}</div>`).join("");
    grid.innerHTML = "";

    const first = new Date(y,m,1);
    const firstDow = first.getDay();
    const daysInMonth = new Date(y,m+1,0).getDate();
    const today = new Date();

    // Title in hint area
    el("calHint").innerHTML = `ğŸ“ <b>${esc(monthName(y,m))}</b> â€” toca un dÃ­a para ver/agregar mensajes.`;

    // Blank cells before 1st
    for(let i=0;i<firstDow;i++){
      const blank = document.createElement("div");
      blank.className = "calCell muted";
      blank.innerHTML = "<div class='calNum'>â€”</div>";
      grid.appendChild(blank);
    }

    const annDates = new Set(getMonthlyAnniversaryDatesForMonth(y,m));
    const monDates = new Set(getMonthCompletedDatesForMonth(y,m));

    for(let d=1; d<=daysInMonth; d++){
      const dateObj = new Date(y,m,d);
      const dateStr = ymd(dateObj);
      const cell = document.createElement("div");
      cell.className = "calCell";
      if(isSameDay(dateObj, today)) cell.classList.add("today");
      if(state.ui.selectedDay === dateStr) cell.classList.add("sel");

      const evCount = notesFor(dateStr).length;
      const isAnn = annDates.has(dateStr);
      const isMon = monDates.has(dateStr);

      cell.innerHTML = `
        <div class="calNum">${d}</div>
        <div class="calDots">
          ${evCount ? `<span class="dot ev" title="Mensaje(s)"></span>` : `<span class="dot" style="opacity:.12"></span>`}
          ${isAnn ? `<span class="dot ann" title="Aniversario mensual"></span>` : ``}
          ${isMon ? `<span class="dot mon" title="Mes cumplido"></span>` : ``}
        </div>
      `;

      cell.addEventListener("click", ()=>{
        state.ui.selectedDay = dateStr;
        el("quickDate").value = dateStr;
        el("sideDate").value = dateStr;
        renderAll();
      });

      grid.appendChild(cell);
    }

    // Keep grid rectangular to 6 rows (optional)
    const cellsNow = grid.children.length;
    const target = 7 * 6; // 42
    for(let k=cellsNow; k<target; k++){
      const blank = document.createElement("div");
      blank.className = "calCell muted";
      blank.innerHTML = "<div class='calNum'>â€”</div>";
      grid.appendChild(blank);
    }
  }

  function renderDayNotesCover(){
    const dateStr = state.ui.selectedDay || ymd(new Date());
    const host = el("dayNotes");
    const arr = notesFor(dateStr);
    host.innerHTML = "";

    const header = document.createElement("div");
    header.className = "pill";
    header.innerHTML = `ğŸ“Œ <span style="opacity:.9">Fecha:</span> <b>${esc(dateStr)}</b>`;
    host.appendChild(header);

    if(arr.length === 0){
      const empty = document.createElement("div");
      empty.className = "coverMsg";
      empty.style.marginTop = "10px";
      empty.innerHTML = `
        <div class="t">No hay mensajitos aquÃ­ (todavÃ­a) ğŸŒ™</div>
        <div class="s">Agrega uno abajo y se verÃ¡ marcado en el calendario.</div>
        <div class="meta">Tip: "Guardar en esa fecha"</div>
      `;
      host.appendChild(empty);
      return;
    }

    arr.slice().reverse().forEach(n=>{
      const div = document.createElement("div");
      div.className = "coverMsg";
      div.style.marginTop = "10px";
      const when = new Date(n.createdAt).toLocaleString();
      div.innerHTML = `
        <div class="t">${n.type==="event"?"ğŸ’—":"ğŸ“"} ${esc(n.title)}</div>
        <div class="s">${esc((n.body||"").slice(0,140))}${(n.body||"").length>140?"â€¦":""}</div>
        <div class="meta">${esc(when)}</div>
        <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn" data-edit="${esc(n.id)}">âœï¸ Editar</button>
          <button class="btn danger" data-del="${esc(n.id)}">ğŸ—‘ï¸ Borrar</button>
        </div>
      `;
      div.querySelector("[data-del]").addEventListener("click", ()=>{
        if(confirm("Â¿Borrar este mensajito? Luego no digas â€˜se me olvidÃ³â€™. ğŸ˜Œ")){
          deleteNote(dateStr, n.id);
        }
      });
      div.querySelector("[data-edit]").addEventListener("click", ()=>{
        const newTitle = prompt("TÃ­tulo corto:", n.title || "");
        if(newTitle === null) return;
        const newBody = prompt("Detalle (opcional):", n.body || "");
        if(newBody === null) return;
        editNote(dateStr, n.id, { title: newTitle.trim() || n.title, body: (newBody||"").trim() });
      });
      host.appendChild(div);
    });
  }

  function renderSideNotes(){
    const dateStr = el("sideDate").value || state.ui.selectedDay || "";
    const host = el("sideNotes");
    host.innerHTML = "";
    if(!dateStr){
      host.innerHTML = `<div class="item"><div class="tag">ğŸ“Œ</div><p>Elige una fecha para ver sus mensajitos.</p></div>`;
      return;
    }
    const arr = notesFor(dateStr).slice().reverse();
    if(arr.length === 0){
      host.innerHTML = `<div class="item"><div class="tag">${esc(dateStr)}</div><p>Sin mensajitos todavÃ­a. Agrega uno desde la portada o el calendario.</p></div>`;
      return;
    }
    arr.forEach(n=>{
      const when = new Date(n.createdAt).toLocaleString();
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="tag">ğŸ—“ï¸ ${esc(dateStr)} â€¢ ${esc(when)}</div>
        <h3>${esc(n.title)}</h3>
        <p>${esc(n.body || "")}</p>
        <div class="btns">
          <button class="btn danger" data-del="${esc(n.id)}">ğŸ—‘ï¸ Borrar</button>
        </div>
      `;
      div.querySelector("[data-del]").addEventListener("click", ()=>{
        if(confirm("Â¿Borrar este mensajito?")){
          deleteNote(dateStr, n.id);
        }
      });
      host.appendChild(div);
    });
  }

  // Cover entries list (diary)
  function renderCoverEntries(){
    const box = el("coverEntries");
    box.innerHTML = "";
    const last = (state.entries || []).slice(-3).reverse();
    if(last.length === 0){
      box.innerHTML = `
        <div class="coverMsg">
          <div class="t">AÃºn no hay pÃ¡ginas ğŸŒ™</div>
          <div class="s">Escribe la primera lÃ­neaâ€¦ y listo: ya empezÃ³ la eternidad.</div>
          <div class="meta">Tip: â€œEscribir ahoraâ€</div>
        </div>`;
      return;
    }
    last.forEach(e=>{
      const when = new Date(e.createdAt).toLocaleString();
      const snippet = (e.text||"").trim().slice(0, 140) + (((e.text||"").trim().length>140) ? "â€¦" : "");
      const div = document.createElement("div");
      div.className = "coverMsg";
      div.innerHTML = `
        <div class="t">ğŸ’– ${esc(e.title)}</div>
        <div class="s">${esc(snippet || "â€”")}</div>
        <div class="meta">${esc(when)}</div>
      `;
      box.appendChild(div);
    });
  }

  // Diary
  function addEntry(title, text){
    const t = sanitize(title);
    const x = sanitize(text);
    if(!t && !x){
      alert("Escribe algo, aunque sea una lÃ­nea. La eternidad no se llena sola. ğŸ˜Œ");
      return;
    }
    state.entries.push({
      id: uid(),
      createdAt: nowISO(),
      title: t || "Sin tÃ­tulo (pero con amor) ğŸ’˜",
      text: x
    });
    save();
  }
  function deleteEntry(id){
    state.entries = state.entries.filter(e=>e.id!==id);
    save();
  }
  function updateEntry(id, patch){
    const i = state.entries.findIndex(e=>e.id===id);
    if(i<0) return;
    state.entries[i] = { ...state.entries[i], ...patch };
    save();
  }
  function renderEntriesList(){
    const host = el("entriesList");
    host.innerHTML = "";
    const arr = [...state.entries].reverse();
    arr.forEach(e=>{
      const div = document.createElement("div");
      div.className = "item";
      const when = new Date(e.createdAt).toLocaleString();
      div.innerHTML = `
        <div class="tag">ğŸ—“ï¸ ${esc(when)}</div>
        <h3 contenteditable="true" data-id="${esc(e.id)}" data-k="title">${esc(e.title)}</h3>
        <p contenteditable="true" data-id="${esc(e.id)}" data-k="text">${esc(e.text)}</p>
        <div class="btns">
          <button class="btn danger" data-del="${esc(e.id)}">ğŸ—‘ï¸ Borrar</button>
        </div>
      `;
      div.querySelector("[data-del]").addEventListener("click", ()=>{
        if(confirm("Â¿Borrar esta pÃ¡gina? Una vez se vaâ€¦ se va. ğŸ˜¶")){
          deleteEntry(e.id);
        }
      });
      host.appendChild(div);
    });

    host.querySelectorAll("[contenteditable='true']").forEach(n=>{
      n.addEventListener("input", ()=>{
        const id = n.getAttribute("data-id");
        const k = n.getAttribute("data-k");
        updateEntry(id, { [k]: n.innerText.trim() });
      });
    });
  }

  // Secrets (casual)
  function simpleHash(str){
    let h = 2166136261;
    for(let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return (h>>>0).toString(16);
  }
  function xorBytes(text, key){
    const t = new TextEncoder().encode(text);
    const k = new TextEncoder().encode(key);
    const out = new Uint8Array(t.length);
    for(let i=0;i<t.length;i++) out[i] = t[i] ^ k[i % k.length];
    return out;
  }
  function toB64(u8){
    let s=""; u8.forEach(b=> s += String.fromCharCode(b));
    return btoa(s);
  }
  function fromB64(b64){
    const bin = atob(b64);
    const out = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) out[i] = bin.charCodeAt(i);
    return out;
  }
  function encryptAndStore(key, text){
    state.secrets.payload = toB64(xorBytes(text, key));
    state.secrets.keyHash = simpleHash(key);
    save();
  }
  function decryptPayload(key){
    if(!state.secrets.payload) return "";
    const bytes = fromB64(state.secrets.payload);
    const k = new TextEncoder().encode(key);
    const out = new Uint8Array(bytes.length);
    for(let i=0;i<bytes.length;i++) out[i] = bytes[i] ^ k[i % k.length];
    return new TextDecoder().decode(out);
  }

  // Modals
  const settingsBack = el("settingsBack");
  const secretBack = el("secretBack");
  const calendarBack = el("calendarBack");
  function openModal(back){ back.classList.add("show"); back.setAttribute("aria-hidden","false"); }
  function closeModal(back){ back.classList.remove("show"); back.setAttribute("aria-hidden","true"); }

  // Export/Import
  function doExport(){
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], { type:"application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    const stamp = new Date().toISOString().slice(0,10);
    a.download = `nuestra_historia_${stamp}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
  }
  async function doImport(file){
    try{
      const text = await file.text();
      const incoming = JSON.parse(text);
      if(!incoming || typeof incoming !== "object") throw new Error("Formato invÃ¡lido");
      const ok = confirm("Â¿Importar y REEMPLAZAR tu historia actual por la del archivo?\n(Si no, cancela y exporta antes).");
      if(!ok) return;

      state.meta = incoming.meta || state.meta;
      state.together = incoming.together || state.together;
      state.entries = Array.isArray(incoming.entries) ? incoming.entries : [];
      state.notes = (incoming.notes && typeof incoming.notes==="object") ? incoming.notes : {};
      state.secrets = incoming.secrets || state.secrets;
      state.ui = incoming.ui || state.ui;

      save();
      alert("Listo. VolviÃ³ a respirar. ğŸ’–");
    }catch(e){
      alert("No pude importar ese archivo. AsegÃºrate que sea .json exportado desde aquÃ­.");
    }
  }

  function syncSettingsUI(){
    el("togetherDate").value = state.together.startDate || "";
    el("togetherTime").value = state.together.startTime || "";
    el("togetherLabel").value = state.together.label || "";
  }

  function renderAll(){
    renderTogether();
    renderCalendar();
    renderDayNotesCover();
    renderCoverEntries();
    renderEntriesList();
    renderSideNotes();
    syncSettingsUI();

    // Default selected day if empty
    if(!state.ui.selectedDay){
      state.ui.selectedDay = ymd(new Date());
    }
    // default date inputs
    if(!el("quickDate").value) el("quickDate").value = state.ui.selectedDay;
    if(!el("sideDate").value) el("sideDate").value = state.ui.selectedDay;
  }

  // Events wiring
  // Cover actions
  const cover = el("cover");
  el("btnEnter").addEventListener("click", ()=> cover.classList.add("hide"));
  el("btnGoWrite").addEventListener("click", ()=>{
    cover.classList.add("hide");
    setTimeout(()=>{ el("entryTitle").focus(); window.scrollTo({top:0,behavior:"smooth"}); }, 160);
  });

  el("btnQuickAdd").addEventListener("click", ()=>{
    const dateStr = el("quickDate").value;
    addNote(dateStr, {
      type: el("quickType").value,
      title: el("quickTitle").value,
      body: el("quickBody").value
    });
    el("quickTitle").value = "";
    el("quickBody").value = "";
  });

  el("calPrev").addEventListener("click", ()=>{
    let y = state.ui.calYear, m = state.ui.calMonth - 1;
    if(m < 0){ m = 11; y -= 1; }
    state.ui.calYear = y; state.ui.calMonth = m;
    save();
  });
  el("calNext").addEventListener("click", ()=>{
    let y = state.ui.calYear, m = state.ui.calMonth + 1;
    if(m > 11){ m = 0; y += 1; }
    state.ui.calYear = y; state.ui.calMonth = m;
    save();
  });
  el("calToday").addEventListener("click", ()=>{
    const d = new Date();
    state.ui.calYear = d.getFullYear();
    state.ui.calMonth = d.getMonth();
    state.ui.selectedDay = ymd(d);
    el("quickDate").value = state.ui.selectedDay;
    el("sideDate").value = state.ui.selectedDay;
    save();
  });

  // Diary buttons
  el("btnSaveEntry").addEventListener("click", ()=>{
    addEntry(el("entryTitle").value, el("entryText").value);
    el("entryTitle").value = "";
    el("entryText").value = "";
    el("entryTitle").focus();
  });
  el("btnClearEntry").addEventListener("click", ()=>{
    el("entryTitle").value = "";
    el("entryText").value = "";
    el("entryTitle").focus();
  });

  // Autosave typing
  let autosaveTimer=null;
  function scheduleSave(){
    clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(save, 220);
  }
  ["entryTitle","entryText","quickDate","quickType","quickTitle","quickBody","sideDate"].forEach(id=>{
    el(id).addEventListener("input", scheduleSave);
    el(id).addEventListener("change", scheduleSave);
  });

  // Side date change -> show notes
  el("sideDate").addEventListener("change", ()=>{
    state.ui.selectedDay = el("sideDate").value || state.ui.selectedDay;
    save();
  });

  // Settings modal open/close
  el("btnOpenSettings").addEventListener("click", ()=> openModal(settingsBack));
  el("btnSettingsQuick").addEventListener("click", ()=> openModal(settingsBack));
  el("settingsClose").addEventListener("click", ()=> closeModal(settingsBack));
  el("btnCloseSettings").addEventListener("click", ()=> closeModal(settingsBack));
  settingsBack.addEventListener("click", (e)=>{ if(e.target===settingsBack) closeModal(settingsBack); });

  el("btnSaveSettings").addEventListener("click", ()=>{
    const d = el("togetherDate").value;
    if(!d){ alert("Pon una fecha. Sin fecha no hay contador. ğŸ˜Œ"); return; }
    state.together.startDate = d;
    state.together.startTime = el("togetherTime").value || "00:00";
    state.together.label = el("togetherLabel").value || "Juntos";
    save();
    closeModal(settingsBack);
  });

  // Secret modal
  el("btnOpenSecret").addEventListener("click", ()=> openModal(secretBack));
  el("btnSecretQuick").addEventListener("click", ()=> openModal(secretBack));
  el("secretClose").addEventListener("click", ()=> closeModal(secretBack));
  secretBack.addEventListener("click", (e)=>{ if(e.target===secretBack) closeModal(secretBack); });

  let unlockedKey="";
  const secretZone = el("secretZone");
  el("btnUnlock").addEventListener("click", ()=>{
    const key = sanitize(el("secretKey").value);
    if(!key){ alert("Pon una clave. Sin clave no hay cofre. ğŸ’Œ"); return; }
    if(state.secrets.keyHash && state.secrets.keyHash !== simpleHash(key)){
      alert("Esa clave no coincide. AquÃ­ no se adivina, se recuerda. ğŸ˜Œ");
      return;
    }
    unlockedKey = key;
    secretZone.style.display="block";
    el("secretText").value = decryptPayload(key) || "";
    el("secretText").focus();
  });
  el("btnSaveSecret").addEventListener("click", ()=>{
    if(!unlockedKey){ alert("Primero abre con tu clave."); return; }
    encryptAndStore(unlockedKey, el("secretText").value || "");
    alert("Secreto guardado. ğŸŒ¹");
  });
  el("btnLock").addEventListener("click", ()=>{
    unlockedKey="";
    el("secretKey").value="";
    el("secretText").value="";
    secretZone.style.display="none";
    closeModal(secretBack);
  });

  // Long-press on logo to open secrets
  let pressTimer=null;
  const pressStart=()=>{ clearTimeout(pressTimer); pressTimer=setTimeout(()=>openModal(secretBack), 900); };
  const pressEnd=()=> clearTimeout(pressTimer);
  el("roseHeader").addEventListener("mousedown", pressStart);
  el("roseHeader").addEventListener("mouseup", pressEnd);
  el("roseHeader").addEventListener("mouseleave", pressEnd);
  el("roseHeader").addEventListener("touchstart", pressStart, {passive:true});
  el("roseHeader").addEventListener("touchend", pressEnd);

  // Calendar modal from app
  el("btnOpenCalendar").addEventListener("click", ()=> openModal(calendarBack));
  el("dockCal").addEventListener("click", ()=> openModal(calendarBack));
  el("calendarClose").addEventListener("click", ()=> closeModal(calendarBack));
  el("calPickClose").addEventListener("click", ()=> closeModal(calendarBack));
  calendarBack.addEventListener("click", (e)=>{ if(e.target===calendarBack) closeModal(calendarBack); });

  el("calPickGo").addEventListener("click", ()=>{
    const d = el("calDatePick").value;
    if(!d){ alert("Elige una fecha."); return; }
    state.ui.selectedDay = d;
    el("sideDate").value = d;
    el("quickDate").value = d;
    save();
    closeModal(calendarBack);
  });

  // Dock
  el("dockWrite").addEventListener("click", ()=>{
    cover.classList.add("hide");
    setTimeout(()=> el("entryTitle").focus(), 160);
  });
  el("dockSettings").addEventListener("click", ()=> openModal(settingsBack));
  el("dockSecret").addEventListener("click", ()=> openModal(secretBack));

  // Export / Import
  el("btnExport").addEventListener("click", doExport);
  el("btnImport").addEventListener("click", ()=> el("fileImport").click());
  el("fileImport").addEventListener("change", async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    if(!file) return;
    await doImport(file);
    ev.target.value = "";
  });

  // Init
  load();
  seedPetals();

  // Seed starter content
  if(state.entries.length === 0){
    state.entries.push({
      id: uid(),
      createdAt: nowISO(),
      title: "PÃ¡gina 1: El comienzo",
      text:
`Hoy abro este espacio como quien abre un cofre.
AquÃ­ guardamos lo que sÃ­ vale: miradas, promesas, fechas y detalles.
Si el tiempo correâ€¦ que corra. Nosotros dejamos huella. â™¾ï¸`
    });
  }
  if(Object.keys(state.notes).length === 0){
    // Add an example monthly reminder in the start day
    const start = parseStart();
    if(start){
      const ds = ymd(start);
      ensureDateKey(ds);
      state.notes[ds].push({
        id: uid(),
        type: "event",
        title: "Nuestro inicio ğŸ’",
        body: "El dÃ­a que dijimos: va en serio. ğŸ•¯ï¸",
        createdAt: nowISO()
      });
    }
  }
  if(!state.ui.selectedDay){
    state.ui.selectedDay = ymd(new Date());
  }

  save();
  setInterval(renderTogether, 20000);
})();
</script>
</body>
</html>
